<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .section-card {
            margin-bottom: 1rem;
            border: 1px solid #dee2e6;
        }
        .section-header {
            cursor: pointer;
            padding: 1rem;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        .section-content {
            padding: 1rem;
            background-color: white;
        }
        .json-viewer {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
        }
        .loading {
            display: none;
        }
        .content-preview {
            max-height: 200px;
            overflow-y: auto;
        }
        .badge-type {
            font-size: 0.7em;
            margin-left: 0.5em;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h1 class="h4 mb-0">
                            <i class="fas fa-spider me-2"></i>Web Scraper
                        </h1>
                        <p class="mb-0 small">Advanced web scraping with JavaScript rendering</p>
                    </div>
                    <div class="card-body">
                        <!-- URL Input Form -->
                        <form id="scrapeForm" method="post" action="/scrape-web">
                            <div class="mb-3">
                                <label for="url" class="form-label">Enter URL to scrape:</label>
                                <div class="input-group">
                                    <input type="url" 
                                           class="form-control" 
                                           id="url" 
                                           name="url" 
                                           placeholder="https://example.com"
                                           value="{{ url or '' }}"
                                           required>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-search me-1"></i> Scrape
                                    </button>
                                </div>
                                <div class="form-text">
                                    Try: 
                                    <a href="#" class="url-example" data-url="https://en.wikipedia.org/wiki/Artificial_intelligence">Wikipedia</a> • 
                                    <a href="#" class="url-example" data-url="https://vercel.com/">Vercel</a> • 
                                    <a href="#" class="url-example" data-url="https://news.ycombinator.com/">Hacker News</a>
                                </div>
                            </div>
                        </form>

                        <!-- Loading Indicator -->
                        <div id="loading" class="alert alert-info loading">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                <span>Scraping website... This may take a moment.</span>
                            </div>
                        </div>

                        <!-- Error Message -->
                        {% if has_error %}
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Error:</strong> {{ error }}
                        </div>
                        {% endif %}

                        <!-- Results Section -->
                        {% if result %}
                        <div id="results" class="mt-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h3 class="h5 mb-0">Scraping Results</h3>
                                <div>
                                    <button id="downloadJson" class="btn btn-success btn-sm me-2">
                                        <i class="fas fa-download me-1"></i> Download JSON
                                    </button>
                                    <button id="toggleAll" class="btn btn-secondary btn-sm">
                                        <i class="fas fa-expand me-1"></i> Toggle All
                                    </button>
                                </div>
                            </div>

                            <!-- Metadata -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h4 class="h6 mb-0">Page Information</h4>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>URL:</strong> <a href="{{ result.result.url }}" target="_blank">{{ result.result.url }}</a></p>
                                            <p><strong>Title:</strong> {{ result.result.meta.title or 'No title found' }}</p>
                                            <p><strong>Description:</strong> {{ result.result.meta.description or 'No description found' }}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>Language:</strong> {{ result.result.meta.language or 'Unknown' }}</p>
                                            <p><strong>Canonical URL:</strong> {{ result.result.meta.canonical or 'None' }}</p>
                                            <p><strong>Strategy:</strong> <span class="badge bg-info">{{ result.strategy }}</span></p>
                                            <p><strong>Processing Time:</strong> {{ "%.2f"|format(result.processing_time) }}s</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Interactions -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h4 class="h6 mb-0">Interactions</h4>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <p><strong>Clicks Attempted:</strong> {{ result.result.interactions.clicks|length }}</p>
                                            {% if result.result.interactions.clicks %}
                                            <ul class="small">
                                                {% for click in result.result.interactions.clicks %}
                                                <li>{{ click }}</li>
                                                {% endfor %}
                                            </ul>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-4">
                                            <p><strong>Scrolls:</strong> {{ result.result.interactions.scrolls }}</p>
                                        </div>
                                        <div class="col-md-4">
                                            <p><strong>Pages Visited:</strong> {{ result.result.interactions.pages|length }}</p>
                                            {% if result.result.interactions.pages %}
                                            <ul class="small">
                                                {% for page in result.result.interactions.pages %}
                                                <li><a href="{{ page }}" target="_blank">{{ page[:50] }}...</a></li>
                                                {% endfor %}
                                            </ul>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Errors -->
                            {% if result.result.errors %}
                            <div class="card mb-3 border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <h4 class="h6 mb-0">Errors ({{ result.result.errors|length }})</h4>
                                </div>
                                <div class="card-body">
                                    {% for error in result.result.errors %}
                                    <div class="mb-2">
                                        <strong>{{ error.phase }}:</strong> {{ error.message }}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}

                            <!-- Sections -->
                            <h4 class="h5 mb-3">Content Sections ({{ result.result.sections|length }})</h4>
                            {% for section in result.result.sections %}
                            <div class="card section-card">
                                <div class="section-header" data-bs-toggle="collapse" data-bs-target="#section-{{ loop.index }}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>{{ section.label }}</strong>
                                            <span class="badge bg-secondary badge-type">{{ section.type }}</span>
                                            {% if section.truncated %}
                                            <span class="badge bg-warning badge-type">truncated</span>
                                            {% endif %}
                                        </div>
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                </div>
                                <div id="section-{{ loop.index }}" class="collapse">
                                    <div class="section-content">
                                        <!-- Section Content -->
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6>Content Summary</h6>
                                                {% if section.content.headings %}
                                                <p><strong>Headings:</strong> {{ section.content.headings|join(', ') }}</p>
                                                {% endif %}
                                                
                                                {% if section.content.text %}
                                                <p><strong>Text:</strong></p>
                                                <div class="content-preview small bg-light p-2">
                                                    {{ section.content.text[:500] }}{% if section.content.text|length > 500 %}...{% endif %}
                                                </div>
                                                {% endif %}
                                                
                                                {% if section.content.links %}
                                                <p class="mt-2"><strong>Links ({{ section.content.links|length }}):</strong></p>
                                                <ul class="small">
                                                    {% for link in section.content.links[:5] %}
                                                    <li><a href="{{ link.href }}" target="_blank">{{ link.text or link.href }}</a></li>
                                                    {% endfor %}
                                                    {% if section.content.links|length > 5 %}
                                                    <li>... and {{ section.content.links|length - 5 }} more</li>
                                                    {% endif %}
                                                </ul>
                                                {% endif %}
                                            </div>
                                            
                                            <div class="col-md-6">
                                                {% if section.content.images %}
                                                <p><strong>Images ({{ section.content.images|length }}):</strong></p>
                                                <div class="row row-cols-2 g-2">
                                                    {% for image in section.content.images[:4] %}
                                                    <div class="col">
                                                        <div class="border p-1 text-center">
                                                            <img src="{{ image.src }}" 
                                                                 alt="{{ image.alt }}" 
                                                                 class="img-fluid"
                                                                 style="max-height: 80px;">
                                                            <div class="small text-truncate">{{ image.alt or 'No alt text' }}</div>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                    {% if section.content.images|length > 4 %}
                                                    <div class="col">
                                                        <div class="border p-2 text-center h-100 d-flex align-items-center justify-content-center">
                                                            +{{ section.content.images|length - 4 }} more
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                                {% endif %}
                                                
                                                {% if section.content.lists %}
                                                <p class="mt-2"><strong>Lists ({{ section.content.lists|length }}):</strong></p>
                                                {% for list in section.content.lists[:2] %}
                                                <ul class="small">
                                                    {% for item in list[:3] %}
                                                    <li>{{ item }}</li>
                                                    {% endfor %}
                                                    {% if list|length > 3 %}
                                                    <li>... and {{ list|length - 3 }} more items</li>
                                                    {% endif %}
                                                </ul>
                                                {% endfor %}
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <!-- Raw HTML -->
                                        <div class="mt-3">
                                            <h6>Raw HTML</h6>
                                            <div class="json-viewer">
                                                {{ section.rawHtml|e }}
                                            </div>
                                        </div>
                                        
                                        <!-- Full JSON -->
                                        <div class="mt-3">
                                            <button class="btn btn-sm btn-outline-secondary" 
                                                    type="button" 
                                                    data-bs-toggle="collapse" 
                                                    data-bs-target="#json-{{ loop.index }}">
                                                Show Full JSON
                                            </button>
                                            <div id="json-{{ loop.index }}" class="collapse mt-2">
                                                <div class="json-viewer">
                                                    {{ {
                                                        'id': section.id,
                                                        'type': section.type,
                                                        'label': section.label,
                                                        'sourceUrl': section.sourceUrl,
                                                        'content': {
                                                            'headings': section.content.headings,
                                                            'text': section.content.text[:200] + ('...' if section.content.text|length > 200 else ''),
                                                            'links_count': section.content.links|length,
                                                            'images_count': section.content.images|length,
                                                            'lists_count': section.content.lists|length,
                                                            'tables_count': section.content.tables|length
                                                        },
                                                        'truncated': section.truncated
                                                    }|tojson|safe }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}

                            <!-- JSON Download Section -->
                            <div class="card mt-4">
                                <div class="card-header">
                                    <h4 class="h6 mb-0">Complete JSON Output</h4>
                                </div>
                                <div class="card-body">
                                    <textarea id="jsonOutput" class="form-control" rows="10" readonly>{{ pretty_json }}</textarea>
                                    <div class="mt-2">
                                        <button id="copyJson" class="btn btn-outline-secondary btn-sm">
                                            <i class="fas fa-copy me-1"></i> Copy to Clipboard
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="card-footer text-muted small">
                        <div class="d-flex justify-content-between">
                            <span>Web Scraper v1.0.0</span>
                            <span>Using FastAPI + Playwright</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
   <script>
document.addEventListener('DOMContentLoaded', function () {

    /* ---------------- URL Examples ---------------- */
    document.querySelectorAll('.url-example').forEach(function (link) {
        link.addEventListener('click', function (e) {
            e.preventDefault();
            const urlInput = document.getElementById('url');
            if (urlInput) {
                urlInput.value = this.dataset.url;
            }
        });
    });

    /* ---------------- Form Submit Loader ---------------- */
    const scrapeForm = document.getElementById('scrapeForm');
    if (scrapeForm) {
        scrapeForm.addEventListener('submit', function () {
            const loading = document.getElementById('loading');
            if (loading) loading.style.display = 'block';

            const results = document.getElementById('results');
            if (results) results.style.display = 'none';
        });
    }

    /* ---------------- Download JSON ---------------- */
    const downloadBtn = document.getElementById('downloadJson');
    if (downloadBtn) {
        downloadBtn.addEventListener('click', function () {
            const jsonScript = document.getElementById('json-data');
            if (!jsonScript) return;

            const data = JSON.parse(jsonScript.textContent);

            const blob = new Blob(
                [JSON.stringify(data, null, 2)],
                { type: 'application/json' }
            );

            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `scrape-result-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    }

    /* ---------------- Copy JSON ---------------- */
    const copyBtn = document.getElementById('copyJson');
    if (copyBtn) {
        copyBtn.addEventListener('click', function () {
            const textarea = document.getElementById('jsonOutput');
            if (!textarea) return;

            navigator.clipboard.writeText(textarea.value);

            const originalHTML = this.innerHTML;
            this.innerHTML = '<i class="fas fa-check me-1"></i> Copied!';
            setTimeout(() => {
                this.innerHTML = originalHTML;
            }, 2000);
        });
    }

    /* ---------------- Toggle All Sections ---------------- */
    const toggleBtn = document.getElementById('toggleAll');
    if (toggleBtn) {
        toggleBtn.addEventListener('click', function () {
            const headers = document.querySelectorAll('.section-header');
            if (!headers.length) return;

            const firstTargetId = headers[0].getAttribute('data-bs-target');
            const firstTarget = document.querySelector(firstTargetId);
            const isExpanded = firstTarget.classList.contains('show');

            headers.forEach(function (header) {
                const targetId = header.getAttribute('data-bs-target');
                const target = document.querySelector(targetId);
                if (!target) return;

                const collapse =
                    bootstrap.Collapse.getInstance(target) ||
                    new bootstrap.Collapse(target, { toggle: false });

                isExpanded ? collapse.hide() : collapse.show();
            });

            this.innerHTML = isExpanded
                ? '<i class="fas fa-expand me-1"></i> Expand All'
                : '<i class="fas fa-compress me-1"></i> Collapse All';
        });
    }

    /* ---------------- Auto Expand First Section ---------------- */
    const firstHeader = document.querySelector('.section-header');
    if (firstHeader) {
        const targetId = firstHeader.getAttribute('data-bs-target');
        const target = document.querySelector(targetId);
        if (target) {
            new bootstrap.Collapse(target, { toggle: true });
        }
    }

});
</script>
<script id="json-data" type="application/json">
{{ pretty_json | tojson }}
</script>


</body>
</html>